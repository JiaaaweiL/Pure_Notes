# 亚稳态：Metastability
亚稳态指的是：在某一段时间周期之内，信号处于0和1的不定态。在多时钟源设计内，亚稳态不能被消除，只可能被避免。   
![image](https://github.com/user-attachments/assets/d16814e9-884d-435f-bf01-5a50a7d3ee7b)
图1： 同步失败的例子。  BCLK采样的时候，adata正在变化。采样到的信号是亚稳态的，它应该在下一个posedge bclk拉高但是没有。核心问题是每一个flip-flop在设计之初就被赋予了一个
setup time 和hold time。这些被采样的数据必须在setup-time hold-time期间保持稳定，否则就会陷入亚稳态的状态。   

### Synchronizers
当我们在两个时钟域内传递信息的时候，我们要问自己：我们真的要采样跨时钟信号的每一个值吗？  
处理分为两个情况： 首先回答两个问题：   
1. 当跨时钟域处理的时候，我们可以漏采样   
2. 当跨时钟域处理的时候，我们必须全部采集到     
第一种情况： 采集到所有的值是不必要的，但是采样必须是准确的。 一个例子是异步FIFO的格雷码。我们不需要捕捉每一个格雷码，但是一定要保证准确性来判断空满。
第二种情况： CDC信号必须被识别，然后需要ACK来控制另一侧信号变动

### 两级FF同步器。  
**两级FF同步器的核心思路是： 需要等待足够长的时间，让一个亚稳态变成稳态**  
理论上，过两级FF之后的信号仍然可能是亚稳态。这个时候就要算MTBF， Mean Time Before Failure。高速电路可能需要三拍，不过对于一般的情况，两拍足够多了。   
![image](https://github.com/user-attachments/assets/1d6c58f5-5d42-4c49-879f-ff248aeae882)   
常问问题： 是否需要在发送时钟域中将信号寄存后再传递给接收时钟域？  
是，如果从发送时钟域传递的是一个组合逻辑（combinational logic）的输出信号，而该信号没有在发送时钟域寄存，那么这个组合逻辑信号可能在时钟周期内不稳定，组合逻辑信号的不稳定性会导致信号频繁变化，这种频繁变化可能会在 CDC 边界产生小的振荡数据。换句话说，信号频率被放大了，这些频繁的变化增加了被接收时钟域采样的边沿。 由于信号频繁变化，接收时钟域有更高的可能性在信号变化的过程中采样到不稳定的信号。这种情况下，接收时钟域的触发器有较高概率进入亚稳态（metastability）  
![image](https://github.com/user-attachments/assets/3c9a278f-429e-4986-96d2-6056db38d25f)   











