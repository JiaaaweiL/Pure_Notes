# 亚稳态：Metastability
亚稳态指的是：在某一段时间周期之内，信号处于0和1的不定态。在多时钟源设计内，亚稳态不能被消除，只可能被避免。   
![image](https://github.com/user-attachments/assets/d16814e9-884d-435f-bf01-5a50a7d3ee7b)
图1： 同步失败的例子。  BCLK采样的时候，adata正在变化。采样到的信号是亚稳态的，它应该在下一个posedge bclk拉高但是没有。核心问题是每一个flip-flop在设计之初就被赋予了一个
setup time 和hold time。这些被采样的数据必须在setup-time hold-time期间保持稳定，否则就会陷入亚稳态的状态。   

### Synchronizers
当我们在两个时钟域内传递信息的时候，我们要问自己：我们真的要采样跨时钟信号的每一个值吗？  
处理分为两个情况： 首先回答两个问题：   
1. 当跨时钟域处理的时候，我们可以漏采样   
2. 当跨时钟域处理的时候，我们必须全部采集到     
第一种情况： 采集到所有的值是不必要的，但是采样必须是准确的。 一个例子是异步FIFO的格雷码。我们不需要捕捉每一个格雷码，但是一定要保证准确性来判断空满。
第二种情况： CDC信号必须被识别，然后需要ACK来控制另一侧信号变动

### 两级FF同步器：  
**两级FF同步器的核心思路是： 需要等待足够长的时间，让一个亚稳态变成稳态**  
理论上，过两级FF之后的信号仍然可能是亚稳态。这个时候就要算MTBF， Mean Time Before Failure。高速电路可能需要三拍，不过对于一般的情况，两拍足够多了。   
![image](https://github.com/user-attachments/assets/1d6c58f5-5d42-4c49-879f-ff248aeae882)   
常问问题： 是否需要在发送时钟域中将信号寄存后再传递给接收时钟域？  
是，如果从发送时钟域传递的是一个组合逻辑（combinational logic）的输出信号，而该信号没有在发送时钟域寄存，那么这个组合逻辑信号可能在时钟周期内不稳定，组合逻辑信号的不稳定性会导致信号频繁变化，这种频繁变化可能会在 CDC 边界产生小的振荡数据。换句话说，信号频率被放大了，这些频繁的变化增加了被接收时钟域采样的边沿。 由于信号频繁变化，接收时钟域有更高的可能性在信号变化的过程中采样到不稳定的信号。这种情况下，接收时钟域的触发器有较高概率进入亚稳态（metastability）  
![image](https://github.com/user-attachments/assets/3c9a278f-429e-4986-96d2-6056db38d25f)   

## 单bit的跨时钟域同步：   
一般会遇到两个问题： 第一个是快时钟域的信号变化太快，导致采样丢失，或者是采样时机靠近时钟边沿，导致亚稳态问题。 一般有两个解决方法：  
1. 开环的解决方案，没有ACK返回。    
2. 闭环的解决方案，需要ACK信号返回来完成握手。
跨时钟域的信号传递问题：  
- 在快时钟域采样慢时钟域的信号通常来说不是一个问题，设计者一般情况下是放两个FF同步器就可以解决问题了。因为快时钟域的时钟频率快，通常来说会被采样一次或者多次。要求是快时钟域的频率是慢时钟的1.5倍频率或者更多。  
- 从快到慢的控制信号传递要遵循3次边沿原则。  

快到慢的问题：  
问题1：  CDC的pulse传递的太快了，采样不到  
问题2：  Pulse是采样到了，违背了建立保持时间   
解决方法1： 用Open-Loop来解决问题。保持pulse的宽度是接收时钟频率的1.5倍宽，假设是CDC的信号至少被采样一次，运气好的话两次。  
好处： 简单，最快的CDC方法且不需要返回ACK  
坏处：  开环方案的最大问题是其**依赖于设计的特定假设**（如固定的时钟频率和信号脉宽）。一旦设计需求或时钟频率发生变化，可能导致原本设计良好的开环方案不再适用。尤其是当其他工程师误将这种解决方案当作通用解决方案，或者在设计变更时未重新分析时，可能会导致同步失败。      

解决方法2： 用Close-loop来解决问题：所谓close-loop其实就是同步过后返回握手信号，告诉发送端信号可以置位了。   
![image](https://github.com/user-attachments/assets/da2a5416-4b0f-48fa-869a-9ad1b3f6090a)   
优点：稳定，安全性，可靠性。  
缺点： 更多的逻辑门（更多的面积）更大的延迟。  

## 多bit的跨时钟域同步
当多个信号进行跨时钟域传输的时候，简单的同步器不能保证数据的安全。需要多个信号在同一个事务中同时跨时钟域传递时，忽视这些信号的同步采样可能导致问题。 当多个信号同步到另一个时钟域时，即使这些信号在发送时钟域是同步的，在接收时钟域由于**数据偏差（skew）**，它们可能会在**不同的时钟沿上被采样**。即使精确控制这些信号的走线长度，**信号的上升和下降时间差异、芯片工艺上的差异等因素仍可能引入足够的偏差**，导致不同信号在接收时钟域中被不同的时钟沿采样，进而导致采样失败。  
主要策略：  
1. Multi-bit signal consolidation： 如果可行，可以把多bit信号整合成单bit的信号。  
2. Multi-cycle path formulations： 多周期路径，使用同步加载信号去加载信号。（锁存信号，然后发同步加载信号，然后采样）  
3. 格雷码  

Multi-bit signal consolidation的问题： 
1. 两个同时需要的控制信号，因为时钟抖动背错开发送导致数据丢失，如何解决呢？    
![image](https://github.com/user-attachments/assets/f091baa2-0824-4e89-9f11-1598ed9babcb)    
很简单！load 和 enable直接在第一个时钟域内做成一个信号。     

2. 




